--- 
title: "Pokédex Explorer"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: journal
runtime: shiny
---

```{r setup, include=FALSE}
library(tidyverse)
library(flexdashboard)
library(shiny)
library(leaflet)
library(DT)
library(sf)
library(magick)
library(stringr)
library(htmltools)

# Load Colorado ecotone data if available
if (file.exists("poke_data.RData")) {
  load("poke_data.RData")
  co_counties_map <- co_counties_ecotones %>% st_transform(4326)

  poke_by_county <- co_counties_map %>%
    st_drop_geometry() %>%
    select(NAME, ecotone) %>%
    inner_join(pokemon_clean_df, by = "ecotone", relationship = "many-to-many")
}

# Load Pokémon dataset (Tidytuesday)
tuesdata <- try(tidytuesdayR::tt_load(2025, week = 13), silent = TRUE)
if (!inherits(tuesdata, "try-error")) {
  pokemon_df <- tuesdata$pokemon_df
} else {
  pokemon_df <- readr::read_csv(
    "https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-04-01/pokemon_df.csv"
  )
}

# Manual evolution chains (for display purposes)
evo_lines <- list(
  eevee      = c("eevee", "vaporeon", "jolteon", "flareon",
                 "espeon", "umbreon", "leafeon", "glaceon", "sylveon"),
  bulbasaur  = c("bulbasaur", "ivysaur", "venusaur"),
  charmander = c("charmander", "charmeleon", "charizard"),
  squirtle   = c("squirtle", "wartortle", "blastoise")
  # Add more if want
)

# Choices for the stat dropdown
stat_choices <- c(
  "HP"               = "hp",
  "Attack"           = "attack",
  "Defense"          = "defense",
  "Special Attack"   = "special_attack",
  "Special Defense"  = "special_defense",
  "Speed"            = "speed"
)
```

**Evolution Module**

Explore a Pokémon’s stats, sprite, and full evolution line using the controls below.

Row {data-height=150}
-------------------------------------

### Trainer Controls {data-width=30}

```{r}
# Pokémon picker
selectInput(
  "filter_pokemon",
  label   = "Choose a Pokémon:",
  choices = sort(unique(pokemon_df$pokemon)),
  selected = "eevee"
)

# Wrap the stat radio buttons in a scrollable container
div(
  style = "
    max-height: 120px;
    overflow-y: auto;
    padding-right: 5px;
    margin-top: 5px;
  ",
  radioButtons(
    "power_stat",
    label = "Choose a stat to visualize:",
    choices = c(
      "HP"               = "hp",
      "Attack"           = "attack",
      "Defense"          = "defense",
      "Special Attack"   = "special_attack",
      "Special Defense"  = "special_defense",
      "Speed"            = "speed"
    ),
    selected = "hp"
  )
)
```

### Pokémon Sprite Viewer {data-width=70}

```{r}
renderUI({
  selected <- input$filter_pokemon
  req(selected)

  url <- pokemon_df %>%
    dplyr::filter(pokemon == selected) %>%
    dplyr::pull(url_image) %>% .[1]

  if (is.na(url)) {
    return("No image available.")
  }

  div(
    style = "
      height: 200px;
      overflow-y: auto;
      overflow-x: auto;
      padding: 5px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    ",
    tags$img(
      src = url,
      style = "
        max-height: 120px;
        max-width: 80%;
        height: auto;
        width: auto;
        object-fit: contain;
      "
    )
  )
})
```

Row {data-height=180}
-------------------------------------

### Evolution Stat Comparison {data-width=30}

```{r}
renderPlot({
selected <- input$filter_pokemon
stat_col <- input$power_stat
req(selected, stat_col)

# Use same evolution chain as the evolution images

evo_vec <- evo_lines[[tolower(selected)]]
if (is.null(evo_vec)) {
evo_vec <- selected
}

evo_group <- pokemon_df %>%
dplyr::filter(pokemon %in% evo_vec)

validate(
need(nrow(evo_group) > 0, "No evolution stats available for this Pokémon.")
)

# Friendly label for the axis/title

stat_labels <- c(
hp              = "HP",
attack          = "Attack",
defense         = "Defense",
special_attack  = "Special Attack",
special_defense = "Special Defense",
speed           = "Speed"
)

y_lab <- if (stat_col %in% names(stat_labels)) stat_labels[stat_col] else stat_col

ggplot(
evo_group,
aes(
x    = get(stat_col),  # no .data pronoun needed
y    = factor(pokemon, levels = rev(evo_vec)),
fill = type_1
)
) +
geom_col() +
coord_flip() +
theme_minimal() +
labs(
title = paste(selected, "Evolution", y_lab, "Stats"),
x     = y_lab,
y     = "Pokémon"
)
})
```

### Evolution Line {data-width=70}

```{r}
renderUI({
  selected <- input$filter_pokemon
  req(selected)

  # Look up evolution chain; if none, use just the selected Pokémon
  evo_vec <- evo_lines[[tolower(selected)]]
  if (is.null(evo_vec)) {
    evo_vec <- selected
  }

  urls <- pokemon_df %>%
    filter(pokemon %in% evo_vec) %>%
    arrange(match(pokemon, evo_vec)) %>%
    pull(url_image) %>%
    unique() %>%
    na.omit()

  if (length(urls) == 0) {
    return(tags$p("No evolution images available.", style = "color:#444;"))
  }

  div(
    style = "
      height: 200px;
      overflow-y: auto;
      overflow-x: auto;
      padding: 5px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    ",
    lapply(urls, function(u) {
      tags$img(
        src = u,
        style = "
          max-height: 120px;
          width: auto;
          object-fit: contain;
        "
      )
    })
  )
})
```

============================================================  
# **Colorado PokéMap Module**
============================================================

Row {data-height=300}
-------------------------------------

### Colorado PokéMap {data-width=65}

View where each Pokémon appears across Colorado’s ecotones. Select a Pokémon on the right to highlight its counties and view its ecotone, type, and generation.

```{r}
if (!exists("co_counties_map")) {
  renderLeaflet({ leaflet() })
} else {
  renderLeaflet({
    poke <- input$chosen_pokemon

    highlight <- poke_by_county %>%
      filter(pokemon == poke) %>%
      pull(NAME)

    fill <- ifelse(co_counties_map$NAME %in% highlight, "orange", "lightblue")

    leaflet(co_counties_map) %>%
      addTiles() %>%
      addPolygons(
        label = ~NAME,
        fillColor = fill,
        fillOpacity = 0.6,
        color = "white",
        weight = ifelse(co_counties_map$NAME %in% highlight, 4, 1)
      )
  })
}
```

### Pokémon Details {data-width=35}

```{r}
if (exists("poke_by_county")) {
  selectInput(
    "chosen_pokemon",
    "Select a Pokémon:",
    choices = sort(unique(poke_by_county$pokemon))
  )
}
```

```{r}
renderUI({
  req(input$chosen_pokemon)

  if (!exists("poke_by_county"))
    return("Colorado dataset unavailable.")

  row <- poke_by_county %>% filter(pokemon == input$chosen_pokemon) %>% slice(1)

  tags$div(
    tags$img(src = row$url_image[1], style="max-width:150px;"),
    tags$p(paste("Ecotone:", row$ecotone)),
    tags$p(paste("Type:", row$type_1)),
    tags$p(paste("Generation:", row$generation_id))
  )
})
```
